(()=>{const component={name:"app_builder",ccm:"https://ccmjs.github.io/ccm/versions/ccm-22.6.1.js",config:{builder:["ccm.component","https://ccmjs.github.io/akless-components/json_builder/versions/ccm.json_builder-1.4.1.js",{directly:true,nosubmit:true}],css:["ccm.load","https://ccmjs.github.io/akless-components/app_builder/resources/styles.css","https://ccmjs.github.io/akless-components/libs/bootstrap-4/css/bootstrap.min.css",{context:"head",url:"https://ccmjs.github.io/akless-components/libs/bootstrap-4/css/bootstrap.min.css"}],data:{store:["ccm.store"]},html:["ccm.load","https://ccmjs.github.io/akless-components/app_builder/resources/templates.html"],warning:"Are you sure you want to delete this App?"},Instance:function(){let $;const self=this;let builder;this.ready=(async()=>{$=this.ccm.helper;this.logger&&this.logger.log("ready",$.privatize(this,true))});this.start=(async()=>{let dataset=await $.dataset(this.data);this.logger&&this.logger.log("start",$.clone(dataset));let app_id=dataset.key;delete dataset.key;const is_local=!this.data.store.source().name;let is_new=!Object.keys(dataset).length;$.setContent(this.element,$.html(this.html.main,{onCreate:createApp,onRead:readApp,onUpdate:updateApp,onDelete:deleteApp}));if(!this.app)$.removeElement(this.element.querySelector("#preview"));if(this.lang){$.append(this.element.querySelector("#top"),this.lang.root);this.lang.start()}if(this.user)$.append(this.element.querySelector("#top"),this.user.root);await renderApp();async function renderApp(){builder=await self.builder.start({root:self.element.querySelector("#builder"),data:{store:["ccm.store",{app:dataset}],key:"app"},onchange:async()=>{self.onchange&&self.onchange(self,"change");await updatePreview()}});if(app_id&&!is_new)!is_local&&self.element.querySelectorAll(".disabled").forEach(button=>button.classList.remove("disabled"));else{self.element.querySelector("#button-update").classList.add("disabled");self.element.querySelector("#button-delete").classList.add("disabled")}await updatePreview()}async function createApp(){try{self.user&&await self.user.login()}catch(e){return}const metadata=await getMetadata();dataset=self.getValue();delete dataset.key;if(self.user)dataset._={access:{get:"all",set:"creator",del:"creator"}};if(metadata)dataset.meta=[self.meta_store.source(),metadata.key];app_id=await self.data.store.set(dataset);delete dataset.key;if(metadata){metadata.source=[metadata.source,app_id];await self.meta_store.set(metadata)}self.logger&&self.logger.log("create",{config:$.clone(dataset),metadata:$.clone(metadata)});is_new=false;if(!self.modal_dialog)alert("App created successfully. App ID: "+app_id);self.onchange&&self.onchange(self,"create");await handoverApp();function getMetadata(){return new Promise(resolve=>{if(!self.meta_store||!self.form||is_local)return resolve(null);self.element.querySelector("#main").style.display="none";$.append(self.element,$.html({id:"form"}));self.form.start({root:self.element.querySelector("#form"),data:{store:["ccm.store",self.data.store.source()]},onfinish:async form=>{try{self.user&&await self.user.login()}catch(e){return}$.removeElement(self.element.querySelector("#form"));self.element.querySelector("#main").style.display="block";const meta=form.getValue();const user=self.user.data();Object.assign(meta,{key:$.generateKey(),metaFormat:"ccm-meta",metaVersion:"2.0.0",format:"application/json",license:"CC0",path:self.app.url||self.app.index,source:self.data.store.source(),creator:user.name||user.user||user.key||"",tags:[],ignore:{demos:[],builders:[]},_:{access:{get:"all",set:"creator",del:"creator"}}});resolve(meta)}})})}}async function readApp(){self.logger&&self.logger.log("read");if(self.modal_dialog&&self.helper){const content=$.html(self.html.read,{embed:async()=>{const result=self.helper.decomposeEmbedCode(content.querySelector("#embed_code").value.trim());result&&await load(result.key,result.store.name?await ccm.store(result.store):undefined);dialog.close()},app_id:async()=>{await load(content.querySelector("#app_id").value.trim());dialog.close()},url:async()=>{const result=self.helper.decomposeAppURL(content.querySelector("#app_url").value.trim());result&&await load(result.key,result.store.name?await ccm.store(result.store):undefined);dialog.close()}});const dialog=await self.modal_dialog.start({modal_title:"Loading an existing App",modal_content:content,footer:null})}else await load(prompt("Please enter the App-ID"));async function load(key,store=self.data.store){try{self.user&&await self.user.login()}catch(e){return}if(!key)return alert("Invalid App ID");dataset=await store.get(key);if(!dataset)return alert("App not exists");self.logger&&self.logger.log("load",$.clone(dataset));app_id=dataset.key;delete dataset.key;is_new=false;if(!self.app)alert("App successfully loaded");await renderApp();self.onchange&&self.onchange(self,"read")}}async function updateApp(){if(!app_id||is_new||is_local)return;try{self.user&&await self.user.login()}catch(e){return}dataset=builder.getValue();dataset.key=app_id;self.logger&&self.logger.log("update",$.clone(dataset));app_id=await self.data.store.set(dataset);delete dataset.key;if(!self.modal_dialog)alert("App updated successfully. App ID: "+app_id);self.onchange&&self.onchange(self,"update");await handoverApp()}async function deleteApp(){if(!app_id||is_new||is_local||!confirm(self.warning))return;try{self.user&&await self.user.login()}catch(e){return}self.logger&&self.logger.log("delete",$.clone(app_id));if(dataset.meta&&self.meta_store&&!is_local){dataset=await self.data.store.get(app_id);await self.meta_store.del(dataset.meta[1])}await self.data.store.del(app_id);app_id=undefined;is_new=true;dataset={key:$.generateKey()};await renderApp();self.onchange&&self.onchange(self,"delete")}async function handoverApp(){!is_local&&self.element.querySelectorAll(".disabled").forEach(button=>button.classList.remove("disabled"));self.modal_dialog&&await self.modal_dialog.start({modal_title:"Handover of the App",modal_content:(await self.handover_app.start({data:{store:["ccm.store",self.data.store.source()],key:app_id},component_url:self.app.url})).root,footer:null})}async function updatePreview(){if(!self.app)return;let config=self.getValue();if(self.convert)config=await self.convert(config);config.root=self.element.querySelector("#app");await self.app.start(config)}});this.getValue=(()=>builder&&builder.getValue&&$.clone(builder.getValue())||null)}};let b="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[b])return window.ccm.files[b]=component;(b=window.ccm&&window.ccm.components[component.name])&&b.ccm&&(component.ccm=b.ccm);"string"===typeof component.ccm&&(component.ccm={url:component.ccm});let c=(component.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||["latest"])[0];if(window.ccm&&window.ccm[c])window.ccm[c].component(component);else{var a=document.createElement("script");document.head.appendChild(a);component.ccm.integrity&&a.setAttribute("integrity",component.ccm.integrity);component.ccm.crossorigin&&a.setAttribute("crossorigin",component.ccm.crossorigin);a.onload=function(){window.ccm[c].component(component);document.head.removeChild(a)};a.src=component.ccm.url}})();