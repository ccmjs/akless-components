(()=>{const component={name:"app_builder",ccm:"https://ccmjs.github.io/ccm/versions/ccm-25.0.0.js",config:{builder:["ccm.component","https://ccmjs.github.io/akless-components/json_builder/versions/ccm.json_builder-1.4.3.js",{directly:true,nosubmit:true}],css:["ccm.load","https://ccmjs.github.io/akless-components/app_builder/resources/styles.css","https://ccmjs.github.io/akless-components/libs/bootstrap-4/css/bootstrap.min.css",{context:"head",url:"https://ccmjs.github.io/akless-components/libs/bootstrap-4/css/bootstrap.min.css"}],data:{},helper:["ccm.load","https://ccmjs.github.io/akless-components/modules/versions/helper-4.0.1.mjs"],html:["ccm.load","https://ccmjs.github.io/akless-components/app_builder/resources/templates.html"],warning:"Are you sure you want to delete this App?"},Instance:function(){let $;const self=this;let builder;this.init=(async()=>{$=Object.assign({},this.ccm.helper,this.helper)});this.ready=(async()=>{this.logger&&this.logger.log("ready",$.privatize(this,true))});this.start=(async()=>{let dataset=await $.dataset(this.data);this.logger&&this.logger.log("start",$.clone(dataset));const has_store=$.isDatastore(this.data.store);const is_local=has_store&&!this.data.store.source().name;let app_id=has_store&&!is_local&&dataset.key;delete dataset.key;let is_new=!Object.keys(dataset).length||app_id&&!await this.data.store.get(app_id);$.setContent(this.element,$.html(this.html.main,{onCreate:createApp,onRead:readApp,onUpdate:updateApp,onDelete:deleteApp}));if(!this.app)$.remove(this.element.querySelector("#preview"));if(this.lang){$.append(this.element.querySelector("#top"),this.lang.root);this.lang.start()}if(this.user)$.append(this.element.querySelector("#top"),this.user.root);await renderApp();updateButtons();async function renderApp(){builder=await self.builder.start({root:self.element.querySelector("#builder"),data:{store:["ccm.store",{app:$.clone(dataset)}],key:"app"},onchange:async()=>{self.onchange&&self.onchange(self,"change");await updatePreview()}});await updatePreview();async function updatePreview(){if(!self.app)return;let config=self.getValue();if(self.convert)config=await self.convert(config);config.root=self.element.querySelector("#app");await self.app.start(config)}}function updateButtons(){if(has_store&&!is_local&&app_id&&!is_new)self.element.querySelectorAll(".disabled").forEach(button=>button.classList.remove("disabled"));else{self.element.querySelector("#button-update").classList.add("disabled");self.element.querySelector("#button-delete").classList.add("disabled")}}async function createApp(){dataset=self.getValue();delete dataset.key;if($.stringify(dataset).length>5e5)if(self.user){if(!self.user.isLoggedIn())alert("Apps of this size can only be created as logged in user.");await self.user.login()}else return alert("Failed: App size is to big");const metadata=await getMetadata();if(self.user&&self.user.isLoggedIn()&&has_store&&!is_local)dataset._={access:{get:"all",set:"creator",del:"creator"}};if(metadata)dataset.meta=[self.meta_store.source(),metadata.key];if(self.user&&self.user.isLoggedIn()&&has_store&&!is_local){app_id=await self.data.store.set(dataset);delete dataset.key}if(metadata&&app_id){metadata.source=[metadata.source,app_id];await self.meta_store.set(metadata)}self.logger&&self.logger.log("create",{config:$.clone(dataset),metadata:$.clone(metadata)});is_new=!(self.user&&self.user.isLoggedIn()&&has_store&&!is_local);if(!self.modal_dialog)alert("App created successfully."+(app_id?" App ID: "+app_id:""));updateButtons();self.onchange&&self.onchange(self,"create");await handoverApp();function getMetadata(){return new Promise(resolve=>{if(!self.user||!self.user.isLoggedIn()||!self.meta_store||!self.form||!has_store||is_local)return resolve(null);self.element.querySelector("#main").style.visibility="hidden";$.prepend(self.element,$.html({id:"form"}));self.form.start({root:self.element.querySelector("#form"),data:{store:["ccm.store",self.data.store.source()]},onfinish:async(results,form)=>{try{self.user&&await self.user.login()}catch(e){return}$.remove(self.element.querySelector("#form"));self.element.querySelector("#main").style.visibility="visible";const meta=form.getValue();const user=self.user.data();Object.assign(meta,{key:$.generateKey(),metaFormat:"ccm-meta",metaVersion:"2.0.0",format:"application/json",license:"CC0",path:self.app.url||self.app.index,source:self.data.store.source(),creator:user.name||user.user||user.key||"",tags:[],ignore:{demos:[],builders:[]},_:{access:{get:"all",set:"creator",del:"creator"}}});resolve(meta)}})})}}async function readApp(){self.logger&&self.logger.log("read");if(self.modal_dialog){const content=$.html(self.html.read,{embed:async()=>{const result=self.helper.decomposeEmbedCode(content.querySelector("#embed_code").value.trim());result&&await load(result.config);dialog.close()},app_id:async()=>{await load({store:self.data.store,key:content.querySelector("#app_id").value.trim()});dialog.close()},url:async()=>{const result=self.helper.decomposeAppURL(content.querySelector("#app_url").value.trim());result&&await load(result.config);dialog.close()}});if(!has_store||is_local)$.remove(content.querySelector("#id"));const dialog=await self.modal_dialog.start({modal_title:"Loading an existing App",modal_content:content,footer:null})}else await load({store:self.data.store,key:prompt("Please enter the App ID")});async function load(config){if(config&&config.store&&config.key){try{dataset=await self.ccm.get(config.store,config.key)}catch(e){alert("Permission denied")}}else dataset=config||{};if(!dataset)return alert("Loading of the App failed");self.logger&&self.logger.log("load",$.clone(dataset));app_id=has_store&&!is_local&&dataset.key;delete dataset.key;is_new=!app_id;if(!self.app)alert("App successfully loaded");await renderApp();updateButtons();self.onchange&&self.onchange(self,"read")}}async function updateApp(){if(!has_store||is_local||!app_id||is_new)return;try{self.user&&await self.user.login()}catch(e){return}dataset=builder.getValue();dataset.key=app_id;self.logger&&self.logger.log("update",$.clone(dataset));try{app_id=await self.data.store.set(dataset);delete dataset.key}catch(e){return alert("Permission denied")}if(!self.modal_dialog)alert("App updated successfully. App ID: "+app_id);updateButtons();self.onchange&&self.onchange(self,"update");await handoverApp()}async function deleteApp(){if(!has_store||is_local||!app_id||is_new)return;try{self.user&&await self.user.login()}catch(e){return}if(!confirm(self.warning))return;self.logger&&self.logger.log("delete",$.clone(app_id));try{if(dataset.meta&&self.meta_store&&!is_local){dataset=await self.data.store.get(app_id);await self.meta_store.del(dataset.meta[1])}await self.data.store.del(app_id)}catch(e){return alert("Permission denied")}app_id=undefined;is_new=true;dataset={key:$.generateKey()};await renderApp();updateButtons();self.onchange&&self.onchange(self,"delete")}async function handoverApp(){self.modal_dialog&&await self.modal_dialog.start({modal_title:"Handover of the App",modal_content:(await self.handover_app.start({data:self.user&&self.user.isLoggedIn()&&has_store&&!is_local&&app_id?{store:["ccm.store",self.data.store.source()],key:app_id}:{store:["ccm.store",{app:$.clone(dataset)}],key:"app"},component_url:self.app&&self.app.url})).root,footer:null})}});this.getValue=(()=>builder&&builder.getValue&&$.clone(builder.getValue())||null)}};let b="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[b])return window.ccm.files[b]=component;(b=window.ccm&&window.ccm.components[component.name])&&b.ccm&&(component.ccm=b.ccm);"string"===typeof component.ccm&&(component.ccm={url:component.ccm});let c=(component.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||["latest"])[0];if(window.ccm&&window.ccm[c])window.ccm[c].component(component);else{var a=document.createElement("script");document.head.appendChild(a);component.ccm.integrity&&a.setAttribute("integrity",component.ccm.integrity);component.ccm.crossorigin&&a.setAttribute("crossorigin",component.ccm.crossorigin);a.onload=function(){window.ccm[c].component(component);document.head.removeChild(a)};a.src=component.ccm.url}})();