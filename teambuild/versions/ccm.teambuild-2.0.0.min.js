(function(){var component={name:"teambuild",version:[2,0,0],ccm:{url:"https://ccmjs.github.io/ccm/versions/ccm-16.6.1.js",integrity:"sha384-zCsUcQEg4NqpF91vJatXIU7aDUcYENcTCchNCwisDiA1ZzTR+ShsqJtmYIHG120k",crossorigin:"anonymous"},config:{html:{main:{id:"main",inner:[{id:"user"},{id:"teams"}]},team:{class:"team",inner:[{class:"header",inner:[{class:"name",inner:"%name%"},{class:"button"}]},{class:"members"}]},button:{tag:"button",inner:"%caption%",onclick:"%onclick%"},member:{class:"member",inner:{class:"name",inner:"%name%"}}},css:["ccm.load","https://ccmjs.github.io/akless-components/teambuild/resources/default.css"],data:{},text:{team:"Team",leave:"leave",join:"join",free:"free",message:"Nothing to display."},icon:{},editable:true},Instance:function(){const self=this;let my;let $;this.init=(callback=>{$=self.ccm.helper;if(self.user)self.user.onchange=(()=>self.start());if($.isObject(self.data)&&$.isDatastore(self.data.store))self.data.store.onchange=(()=>self.start());callback()});this.ready=(callback=>{my=$.privatize(self);self.logger&&self.logger.log("ready",$.clone(my));callback()});this.start=(callback=>{$.dataset(my.data,dataset=>{self.logger&&self.logger.log("start",$.clone(dataset));if(!dataset.teams)dataset.teams=[];const main_elem=$.html(my.html.main);const teams_elem=main_elem.querySelector("#teams");self.user?self.user.start(()=>{$.setContent(main_elem.querySelector("#user"),self.user.root);proceed()}):proceed();function proceed(){addTeams();$.setContent(self.element,main_elem);callback&&callback();function addTeams(){dataset.teams.map(addTeam);if(my.max_teams){const needed=my.max_teams-dataset.teams.length;for(let i=0;i<needed;i++)addEmptyTeam()}else if((dataset.teams.length===0||!isEmptyTeam(dataset.teams[dataset.teams.length-1]))&&joinableTeams())addEmptyTeam();if(dataset.teams.length===0)$.setContent(teams_elem,my.text.message);function addTeam(team,i){if(i===undefined)i=dataset.teams.length-1;const team_elem=$.html(my.html.team,{icon:my.icon.team,name:team.name?team.name:my.names&&my.names[i]?my.names[i]:my.text.team+" "+(i+1)});const max_members=team.max_members||my.max_members;const user=self.user&&self.user.isLoggedIn()&&self.user.data().user;if($.isObject(my.data)&&$.isDatastore(my.data.store)&&user){const user_team=user&&getUserTeam();if(isMember(team)){if(isEditable(i,"rename"))makeEditable();if(isEditable(i,"leave"))addLeaveButton()}else if(isJoinable())addJoinButton();function isMember(team){return!!team.members[user]}function isEditable(team,action){if(team.editable===undefined)return!(my.editable===false||$.isObject(my.editable)&&my.editable[action]===false);else return!(team.editable===false||$.isObject(team.editable)&&team.editable[action]===false)}function makeEditable(){const name_elem=team_elem.querySelector(".name");name_elem.setAttribute("contenteditable",true);name_elem.addEventListener("input",()=>{const value=name_elem.textContent.trim();team.name=$.protect(value);my.data.store.set(dataset,()=>{self.logger&&self.logger.log("rename",$.clone({team:team.key,name:team.name}))})})}function addLeaveButton(){$.setContent(team_elem.querySelector(".button"),$.html(my.html.button,{icon:my.icon.leave,caption:my.text.leave,onclick:()=>{delete team.members[user];if(!my.max_teams&&isEmptyTeam(team))dataset.teams.splice(i,1);my.data.store.set(dataset,()=>{const event_data={leaved:team.key};self.logger&&self.logger.log("leave",$.clone(event_data));self.onchange&&self.onchange(self,$.clone(event_data));self.start()})}}))}function isJoinable(){if(!isEditable(i,"join"))return false;if(user_team&&!isEditable(user_team-1,"leave"))return false;if(!my.max_teams&&i===dataset.teams.length-1&&i>0){if(isOnlyMember(dataset.teams[i-1]))return false;function isOnlyMember(team){return team.members[user]&&Object.keys(team.members).length===1}}return!max_members||Object.keys(team.members).length<max_members}function addJoinButton(){$.setContent(team_elem.querySelector(".button"),$.html(my.html.button,{icon:my.icon.join,caption:my.text.join,onclick:()=>{const leaving_team=user_team&&dataset.teams[user_team-1];if(user_team){delete leaving_team.members[user];if(!my.max_teams&&isEmptyTeam(leaving_team))dataset.teams.splice(user_team-1,1)}team.members[user]=true;my.data.store.set(dataset,()=>{const event_data={joined:team.key,leaved:leaving_team&&leaving_team.key};self.logger&&self.logger.log("leave",$.clone(event_data));self.onchange&&self.onchange(self,$.clone(event_data));self.start()})}}))}}addMembers();teams_elem.appendChild(team_elem);function getUserTeam(){for(let i=0;i<dataset.teams.length;i++)if(dataset.teams[i].members[user])return i+1}function addMembers(){const members_elem=team_elem.querySelector(".members");for(const member in team.members)addMember(member);for(let i=0;i<max_members-Object.keys(team.members).length;i++)addMember();function addMember(member){const member_elem=$.html(my.html.member,{icon:my.icon.member,name:member?member:my.text.free});const name_elem=member_elem.querySelector(".name");if(user&&member&&user===member)name_elem.classList.add("user");if(!member)name_elem.classList.add("free");members_elem.appendChild(member_elem)}}}function isEmptyTeam(team){return Object.keys(team.members).length===0}function addEmptyTeam(){const team={key:$.generateKey(),members:{}};dataset.teams.push(team);addTeam(team)}function joinableTeams(){return!(my.editable===false||my.editable&&my.editable.join===false)}}}})})}};function p(){window.ccm[v].component(component)}var f="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[f])window.ccm.files[f]=component;else{var n=window.ccm&&window.ccm.components[component.name];n&&n.ccm&&(component.ccm=n.ccm),"string"==typeof component.ccm&&(component.ccm={url:component.ccm});var v=component.ccm.url.split("/").pop().split("-");if(v.length>1?(v=v[1].split("."),v.pop(),"min"===v[v.length-1]&&v.pop(),v=v.join(".")):v="latest",window.ccm&&window.ccm[v])p();else{var e=document.createElement("script");document.head.appendChild(e),component.ccm.integrity&&e.setAttribute("integrity",component.ccm.integrity),component.ccm.crossorigin&&e.setAttribute("crossorigin",component.ccm.crossorigin),e.onload=function(){p(),document.head.removeChild(e)},e.src=component.ccm.url}}})();