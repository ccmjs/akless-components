(function(){const component={name:"user",version:[8,1,0],ccm:"https://ccmjs.github.io/ccm/versions/ccm-18.0.0.js",config:{html:{logged_in:{id:"logged_in",class:"well well-sm",inner:[{id:"user",inner:[{class:"glyphicon glyphicon-user"},"%user%"]},{id:"button",class:"btn btn-default btn-xs",inner:[{tag:"span",class:"glyphicon glyphicon-log-out"},"Logout"],onclick:"%click%"}]},logged_out:{id:"logged_out",class:"well well-sm",inner:{id:"button",class:"btn btn-default btn-xs",inner:[{tag:"span",class:"glyphicon glyphicon-log-in"},"Login"],onclick:"%click%"}},login:{id:"login-form",class:"container",inner:[{id:"loginbox",class:"mainbox col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2",inner:{class:"panel panel-info",inner:[{class:"panel-heading",inner:{class:"panel-title",inner:"%title%"}},{class:"panel-body",inner:[{tag:"form",id:"loginform",class:"form-horizontal",role:"form",onsubmit:"%login%",inner:[{id:"username-entry",class:"input-group",inner:[{tag:"span",class:"input-group-addon",inner:{tag:"i",class:"glyphicon glyphicon-user"}},{tag:"input",id:"login-username",type:"text",class:"form-control",name:"user",placeholder:"username",required:true}]},{id:"password-entry",class:"input-group",inner:[{tag:"span",class:"input-group-addon",inner:{tag:"i",class:"glyphicon glyphicon-lock"}},{tag:"input",id:"login-password",type:"password",class:"form-control",name:"token",placeholder:"password",required:true}]},{class:"form-group",inner:{class:"col-sm-12 controls",inner:[{tag:"input",type:"submit",id:"btn-login",class:"btn btn-success",value:"Login"},{tag:"a",id:"btn-abort",class:"btn btn-warning",onclick:"%abort%",inner:"Abort"}]}}]}]}]}}]}},css:["ccm.load","https://ccmjs.github.io/akless-components/libs/bootstrap/css/bootstrap.css",{context:"head",url:"https://ccmjs.github.io/akless-components/libs/bootstrap/css/font-face.css"},"https://ccmjs.github.io/akless-components/user/resources/default.css"]},Instance:function(){const self=this;let $,my,data,context=this;this.init=(async()=>{$=this.ccm.helper;my=$.privatize(this,"realm","store");let instance=this;while(instance=instance.parent)if($.isInstance(instance.user)&&instance.user.getRealm()===this.getRealm())context=instance.user;if(context===this){context=null;this.onchange=this.onchange?[this.onchange]:[]}else if(this.onchange)context.onchange.push(this.onchange)});this.ready=(async()=>{this.logged_in&&await this.login();this.logger&&this.logger.log("ready",$.privatize(this,true))});this.start=(async()=>{if(context)return context.start();this.logger&&this.logger.log("start",this.isLoggedIn());if(this.isLoggedIn())$.setContent(this.element,$.html(this.html.logged_in,{click:this.logout,user:data.user}));else $.setContent(this.element,$.html(this.html.logged_out,{click:this.login}))});this.login=(async not=>{if(context)return context.login(this.onchange);if(this.isLoggedIn())return;let result;do{switch(my.realm){case"cloud":result=await renderLogin(this.title,true);if(this.hash)result.token=this.hash.md5(result.token);result.realm=my.realm;result.store=my.store;try{result=await this.ccm.load({url:this.url,params:result})}catch(e){result=undefined}break;case"guest":if(this.guest)result={user:this.guest===true?$.generateKey():this.guest};else{result=await renderLogin(this.title);if(!result)return await this.start()}result.token=result.user;break;case"hbrsinfkaul":result=await this.ccm.load({url:"https://kaul.inf.h-brs.de/login/login.php",method:"JSONP",params:{realm:my.realm}});if($.isObject(result))result.token=result.user+"#"+result.token;break;case"hbrsinfpseudo":result=await this.ccm.load({url:"https://kaul.inf.h-brs.de/login/login_pseudonym.php",method:"JSONP",params:{realm:my.realm}});break;default:if(!(result=await renderLogin(this.title,true)))return await this.start();result=await this.ccm.load({url:this.url,method:"POST",params:{realm:my.realm,user:result.user,token:result.token}})}}while(!($.isObject(result)&&$.regex("key").test(result.user)&&typeof result.token==="string")&&!alert("Authentication failed"));data=$.clone(result);this.logger&&this.logger.log("login");await this.start();this.onchange.forEach(onchange=>onchange!==not&&onchange(this.isLoggedIn()));async function renderLogin(title,password){return new Promise(resolve=>{const shadow=self.parent&&self.parent.element&&self.parent.element.parentNode;const parent=shadow?self.root.parentNode||document.createElement("div"):null;if(shadow){self.parent.element.style.display="none";shadow.appendChild(self.root)}$.setContent(self.element,$.html(self.html.login,{title:title,login:event=>{event.preventDefault();finish($.formData(self.element))},abort:()=>finish()}));!password&&$.removeElement(self.element.querySelector("#password-entry"));function finish(result){if(shadow){parent.appendChild(self.root);self.parent.element.style.display="block"}resolve(result)}})}});this.logout=(async not=>{if(context)return context.logout(this.onchange);if(!this.isLoggedIn())return;switch(my.realm){case"cloud":case"guest":break;case"hbrsinfkaul":case"hbrsinfpseudo":await this.ccm.load({url:"https://kaul.inf.h-brs.de/login/logout.php",method:"JSONP",params:{realm:my.realm}}).catch(()=>{});break;default:await this.ccm.load({url:this.url,method:"POST",params:{realm:my.realm,token:data.token}});break}data=undefined;this.logger&&this.logger.log("logout");await this.start();this.onchange.forEach(onchange=>onchange!==not&&onchange(this.isLoggedIn()))});this.isLoggedIn=(()=>{if(context)return context.isLoggedIn();return!!data});this.data=(()=>{if(context)return context.data();return $.clone(data)});this.getRealm=(()=>my.realm)}};let b="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[b])return window.ccm.files[b]=component;(b=window.ccm&&window.ccm.components[component.name])&&b.ccm&&(component.ccm=b.ccm);"string"===typeof component.ccm&&(component.ccm={url:component.ccm});let c=(component.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||["latest"])[0];if(window.ccm&&window.ccm[c])window.ccm[c].component(component);else{var a=document.createElement("script");document.head.appendChild(a);component.ccm.integrity&&a.setAttribute("integrity",component.ccm.integrity);component.ccm.crossorigin&&a.setAttribute("crossorigin",component.ccm.crossorigin);a.onload=function(){window.ccm[c].component(component);document.head.removeChild(a)};a.src=component.ccm.url}})();