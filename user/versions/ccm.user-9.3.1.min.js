(()=>{const component={name:"user",version:[9,3,1],ccm:"https://ccmjs.github.io/ccm/versions/ccm-25.0.0.js",config:{css:["ccm.load","https://ccmjs.github.io/akless-components/libs/bootstrap/css/bootstrap.css",{context:"head",url:"https://ccmjs.github.io/akless-components/libs/bootstrap/css/font-face.css"},"https://ccmjs.github.io/akless-components/user/resources/default.css"],helper:["ccm.load","https://ccmjs.github.io/akless-components/modules/versions/helper-4.0.1.mjs"],html:["ccm.get","https://ccmjs.github.io/akless-components/user/resources/resources.js","html"],realm:"guest",title:"Guest Mode: Please enter any username"},Instance:function(){const self=this;let $,my,data,context=this;this.init=(async()=>{$=Object.assign({},this.ccm.helper,this.helper);my=$.privatize(this,"realm","store");let instance=this;while(instance=instance.parent)if($.isInstance(instance.user)&&instance.user.getRealm()===this.getRealm())context=instance.user;if(context===this){context=null;this.onchange=this.onchange?[this.onchange]:[]}else if(this.onchange)context.onchange.push(this.onchange)});this.ready=(async()=>{$.setContent(this.element,"");if(this.logged_in||sessionStorage.getItem("ccm-user-"+my.realm))await this.login(true);this.logger&&this.logger.log("ready",$.privatize(this,true))});this.start=(async()=>{if(context)return context.start();if(this.isLoggedIn()&&this.element.querySelector("#logged_in")||!this.isLoggedIn()&&this.element.querySelector("#logged_out"))return;this.logger&&this.logger.log("start",this.isLoggedIn());if(this.norender)return;if(this.isLoggedIn())$.setContent(this.element,$.html(this.html.logged_in,{click:this.logout,user:data.user}));else $.setContent(this.element,$.html(this.html.logged_out,{click:this.login}))});this.login=(async not=>{if(context)return context.login(this.onchange);if(this.isLoggedIn())return this.data();let result=sessionStorage.getItem("ccm-user-"+my.realm);if(result)result=$.parse(result);else do{switch(my.realm){case"cloud":result=await renderLogin(this.title,true);if(!result){await this.start();throw new Error("login aborted")}if(this.hash)result.token=this.hash.md5(result.token);result.realm=my.realm;result.store=my.store;try{result=await this.ccm.load({url:this.url,params:result})}catch(e){result=undefined}break;case"guest":if(this.guest)result={user:this.guest===true?$.generateKey():this.guest};else{result=await renderLogin(this.title);if(!result){await this.start();throw new Error("login aborted")}}result.key=result.token=result.user;break;case"hbrsinfkaul":result=await this.ccm.load({url:"https://kaul.inf.h-brs.de/login/login.php",method:"JSONP",params:{realm:my.realm}});if($.isObject(result)){result.key=result.user;result.token=result.user+"#"+result.token}break;case"hbrsinfpseudo":result=await this.ccm.load({url:"https://kaul.inf.h-brs.de/login/login_pseudonym.php",method:"JSONP",params:{realm:my.realm}});if($.isObject(result)){result.key=result.user;result.token=result.user+"#"+result.token}break;case"lea":result={user:sessionStorage.getItem("ccm@lea-user"),token:sessionStorage.getItem("ccm@lea-token")};if(!($.isObject(result)&&result.user&&$.regex("key").test(result.user)&&typeof result.token==="string"))return alert("Authentication failed");break;default:result=await renderLogin(this.title,true);if(!result){await this.start();throw new Error("login aborted")}result=await this.ccm.load({url:this.url,method:"POST",params:{realm:my.realm,user:result.user,token:result.token}})}}while(!($.isObject(result)&&result.user&&$.regex("key").test(result.user)&&typeof result.token==="string")&&!alert("Authentication failed"));data=$.clone(result);sessionStorage.setItem("ccm-user-"+my.realm,$.stringify(data));this.logger&&this.logger.log("login");await this.start();not!==true&&await $.asyncForEach(this.onchange,async onchange=>onchange!==not&&await onchange(this.isLoggedIn()));return data;async function renderLogin(title,password){return new Promise(resolve=>{const shadow=self.parent&&self.parent.element&&self.parent.element.parentNode;const parent=shadow?self.root.parentNode||document.createElement("div"):null;if(shadow){self.parent.element.style.display="none";shadow.appendChild(self.root)}$.setContent(self.element,$.html(self.html.login,{title:title,login:event=>{event.preventDefault();finish($.formData(self.element))},abort:()=>finish()}));!password&&$.remove(self.element.querySelector("#password-entry"));function finish(result){if(shadow){parent[parent.nodeType===11?"removeChild":"appendChild"](self.root);self.parent.element.style.removeProperty("display")}resolve(result)}})}});this.logout=(async not=>{if(context)return context.logout(this.onchange);if(!this.isLoggedIn())return;switch(my.realm){case"cloud":case"guest":break;case"hbrsinfkaul":case"hbrsinfpseudo":await this.ccm.load({url:"https://kaul.inf.h-brs.de/login/logout.php",method:"JSONP",params:{realm:my.realm}}).catch(()=>{});break;case"lea":sessionStorage.removeItem("ccm@lea-user");sessionStorage.removeItem("ccm@lea-token");break;default:await this.ccm.load({url:this.url,method:"POST",params:{realm:my.realm,token:data.token}});break}data=undefined;sessionStorage.removeItem("ccm-user-"+my.realm);this.logger&&this.logger.log("logout");if(this.restart&&this.parent){$.setContent(this.parent.element,$.loading());await this.parent.start()}else await this.start();not!==true&&this.onchange.forEach(onchange=>onchange!==not&&onchange(this.isLoggedIn()))});this.isLoggedIn=(()=>{if(context)return context.isLoggedIn();return!!data});this.data=(()=>{if(context)return context.data();return $.clone(data)});this.getRealm=(()=>my.realm)}};let b="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[b])return window.ccm.files[b]=component;(b=window.ccm&&window.ccm.components[component.name])&&b.ccm&&(component.ccm=b.ccm);"string"===typeof component.ccm&&(component.ccm={url:component.ccm});let c=(component.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||["latest"])[0];if(window.ccm&&window.ccm[c])window.ccm[c].component(component);else{var a=document.createElement("script");document.head.appendChild(a);component.ccm.integrity&&a.setAttribute("integrity",component.ccm.integrity);component.ccm.crossorigin&&a.setAttribute("crossorigin",component.ccm.crossorigin);a.onload=function(){window.ccm[c].component(component);document.head.removeChild(a)};a.src=component.ccm.url}})();