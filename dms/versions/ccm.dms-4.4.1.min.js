(()=>{const component={name:"dms",version:[4,4,1],ccm:"https://ccmjs.github.io/ccm/versions/ccm-25.1.0.js",config:{css:["ccm.load","https://ccmjs.github.io/akless-components/dms/resources/css/dms.css","https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css",{url:"https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css",context:"head"}],helper:["ccm.load","https://ccmjs.github.io/akless-components/modules/versions/helper-4.1.0.mjs"],html:["ccm.load","https://ccmjs.github.io/akless-components/dms/resources/html/dms.html"],menu:["ccm.component","https://ccmjs.github.io/akless-components/menu/versions/ccm.menu-2.10.1.js",["ccm.get","https://ccmjs.github.io/akless-components/dms/resources/resources.js","menu"]],title:"Digital Makerspace"},Instance:function(){let $;this.ready=(async()=>{$=Object.assign({},this.ccm.helper,this.helper);this.logger&&this.logger.log("ready",$.privatize(this,true))});this.start=(async()=>{this.logger&&this.logger.log("start");const apps=this.apps&&await this.ccm.store(await this.apps.get());const components=await this.ccm.store(await this.components.get());$.setContent(this.element,$.html(this.html.main,{logo:this.logo,title:this.title}));const content=this.element.querySelector("#content");const view=[async()=>{this.routing&&this.routing.set("home");$.setContent(content,$.html(this.html.home));if(this.analytics)await this.analytics.start({root:content.querySelector("#analytics")});else $.remove(content.querySelector("#analytics_section"))},async()=>{this.routing&&this.routing.set("apps");if(!this.listing||!this.listing.apps||!this.apps)return $.setContent(content,"");$.setContent(content,$.html(this.html.list));let app_titles={},component={},component_titles={},creators={},categories={},tags={},languages={};const add=(obj,key)=>!obj[key]&&(obj[key]=true);await $.asyncForEach(await apps.get(),async app=>{add(app_titles,app.title);add(creators,app.creator);add(categories,app.category);app.tags&&app.tags.forEach(tag=>add(tags,tag));app.language&&app.language.forEach(language=>add(languages,language));let meta=$.convertComponentURL(app.path);if(!component[app.path])component[app.path]=await components.get(meta.index);meta=component[app.path];meta&&add(component_titles,meta.title)});app_titles=Object.keys(app_titles).sort();creators=Object.keys(creators).sort();categories=Object.keys(categories).sort();tags=Object.keys(tags).sort();languages=Object.keys(languages).sort();component_titles=Object.keys(component_titles).sort();const filters=content.querySelector("#filters");$.setContent(filters,$.html(this.html.filters));const append=(values,id,upper)=>values.forEach(value=>$.append(filters.querySelector("#"+id),$.html({tag:"option",value:upper?value.toUpperCase():value})));append(app_titles,"search_data");append(component_titles,"component_data");append(creators,"creator_data");append(categories,"category_data");append(tags,"tags_data");append(languages,"language_data",true);const updateListing=async()=>{const filtered_apps=(await apps.get()).filter(app=>{let value;value=filters.querySelector("#search").value.toLowerCase();if(value&&(!app.title||!app.title.toLowerCase().includes(value)))return false;value=filters.querySelector("#creator").value.toLowerCase();if(value&&(!app.creator||!app.creator.toLowerCase().includes(value)))return false;value=filters.querySelector("#category").value.toLowerCase();if(value&&(!app.category||!app.category.toLowerCase().includes(value)))return false;value=filters.querySelector("#tags").value.toLowerCase();if(value&&(!app.tags||!app.tags.some(tag=>tag.toLowerCase().includes(value))))return false;value=filters.querySelector("#language").value.toLowerCase();if(value&&(!app.language||!app.language.some(language=>language.toLowerCase().includes(value))))return false;value=filters.querySelector("#component").value.toLowerCase();if(value&&(!component[app.path]||!component[app.path].title.toLowerCase().includes(value)))return false;return true});const ratings=await this.ccm.store(await this.rating.apps.store.get());await this.listing.apps.start({root:content.querySelector("#listing"),convert:async app_meta=>{const component_meta=await components.get($.convertComponentURL(app_meta.path).index);if(!component_meta)return app_meta;app_meta.component=component_meta.title;app_meta.version=component_meta.version;return app_meta},data:filtered_apps,defaults:{icon:""},sort:(a,b)=>{const title_x=a.title.toLowerCase();const title_y=b.title.toLowerCase();const creator_x=(a.creator||"").toLowerCase();const creator_y=(b.creator||"").toLowerCase();if(title_x<title_y)return-1;if(title_x>title_y)return 1;if(creator_x<creator_y)return-1;if(creator_x>creator_y)return 1;return 0},onrender:async event=>{const icon=event.entry.querySelector(".icon");if(!icon.getAttribute("src")){const component=await components.get($.convertComponentURL(event.data.path).index);icon.setAttribute("src",component&&component.icon||this.default_icon||"")}if(!icon.getAttribute("src"))$.remove(event.entry.querySelector(".icon-area"));if(!event.data.component||!event.data.version)$.remove(event.entry.querySelector(".component"));this.rating&&this.rating.apps&&this.rating.apps.component.start({root:event.entry.querySelector(".rating"),"data.store":ratings,"data.key":event.data.key})},onclick:async event=>showApp(event.data.key)})};[...filters.querySelectorAll(".filter input")].forEach(filter=>filter.addEventListener("change",updateListing));await updateListing()},async()=>{this.routing&&this.routing.set("components");if(!this.listing||!this.listing.components)return $.setContent(content,"");$.setContent(content,$.html(this.html.list));const filtered_components=await this.ccm.store(await components.get());await $.asyncForEach(await filtered_components.get(),async component=>{let highest=component;const results=await filtered_components.get({identifier:component.identifier});results.forEach(result=>{const compare=$.compareVersions(result.version,highest.version);compare>0&&filtered_components.del(highest.key);compare<0&&filtered_components.del(result.key)})});let titles={},publishers={},categories={},tags={};const add=(obj,key)=>!obj[key]&&(obj[key]=true);await $.asyncForEach(await filtered_components.get(),async component=>{add(titles,component.title);add(publishers,component.creator);add(categories,component.category);component.tags&&component.tags.forEach(tag=>add(tags,tag))});titles=Object.keys(titles).sort();publishers=Object.keys(publishers).sort();categories=Object.keys(categories).sort();tags=Object.keys(tags).sort();const filters=content.querySelector("#filters");$.setContent(filters,$.html(this.html.filters));const append=(values,id)=>values.forEach(value=>$.append(filters.querySelector("#"+id),$.html({tag:"option",value:value})));$.remove(filters.querySelector("#component_filter"));$.remove(filters.querySelector("#language_filter"));append(titles,"search_data");append(publishers,"creator_data");append(categories,"category_data");append(tags,"tags_data");const updateListing=async()=>{const components=(await filtered_components.get()).filter(component=>{let value;value=filters.querySelector("#search").value.toLowerCase();if(value&&(!component.title||!component.title.toLowerCase().includes(value)))return false;value=filters.querySelector("#creator").value.toLowerCase();if(value&&(!component.creator||!component.creator.toLowerCase().includes(value)))return false;value=filters.querySelector("#category").value.toLowerCase();if(value&&(!component.category||!component.category.toLowerCase().includes(value)))return false;value=filters.querySelector("#tags").value.toLowerCase();if(value&&(!component.tags||!component.tags.some(tag=>tag.toLowerCase().includes(value))))return false;return true});const ratings=await this.ccm.store(await this.rating.components.store.get());await this.listing.components.start({root:content.querySelector("#listing"),data:components,defaults:{icon:this.default_icon,subject:""},sort:(a,b)=>{const title_x=a.title.toLowerCase();const title_y=b.title.toLowerCase();const creator_x=(a.creator||"").toLowerCase();const creator_y=(b.creator||"").toLowerCase();if(title_x<title_y)return-1;if(title_x>title_y)return 1;if(creator_x<creator_y)return-1;if(creator_x>creator_y)return 1;return 0},onrender:event=>{if(!event.data.icon&&!this.default_icon)$.remove(event.entry.querySelector(".header"));this.rating&&this.rating.components&&this.rating.components.component.start({root:event.entry.querySelector(".rating"),"data.store":ratings,"data.key":event.data.key})},onclick:event=>this.component_manager&&showComponent(event.data.key)})};[...filters.querySelectorAll(".filter input")].forEach(filter=>filter.addEventListener("change",updateListing));await updateListing()},()=>{this.routing&&this.routing.set("publish");if(!this.user||!this.components||!this.form)return $.setContent(content,"");this.form.start({root:content,data:{store:["ccm.store",this.components.source()]},onfinish:{condition:async results=>{try{await this.ccm.component(results.path)}catch(e){alert("Publish failed. Your component is not valid.");return false}const data=$.convertComponentURL(results.path);const component=await this.components.get({name:data.name});if(component.length)alert(`Publish failed. A component with the unique name '${data.name}' has already been released.`);return!component.length},convert:async(json,instance)=>{const user=this.user.data();Object.assign(json,{key:instance.data.key=$.convertComponentURL(json.path).index,metaFormat:"ccm-meta",metaVersion:"2.0.0",format:"application/js",license:"MIT Licence",creator:user.name||user.user||user.key||"",tags:[],ignore:{demos:[],builders:[]},_:{access:{get:"all",set:"creator",del:"creator"}}});if(!json.icon&&this.default_icon)json.icon=this.default_icon;json.version=json.key.split("-");json.identifier=json.version.shift();json.version=json.version.join(".");return json},login:true,store:true,alert:"Congratulations! You have successfully published a component.",callback:async results=>{await components.set(results);await showComponent(results.key)}}})}];const showApp=async id=>{this.routing&&this.routing.set(`app-${id}`);if(!this.app_manager)return $.setContent(content,"");await this.app_manager.start({root:content,data:{store:["ccm.store",this.apps.source()],key:id},default_icon:(await components.get($.convertComponentURL((await apps.get(id)).path).index)).icon||this.default_icon,onchange:async event=>{if(event.event==="update")await apps.set(await this.apps.get(id));if(event.event==="delete"){await apps.del(event.dataset.key);alert("App deleted successfully");menu.select("apps")}},onstart:async app_manager=>{const meta=await apps.get(id);$.append(app_manager.element.querySelector("#main"),$.html({id:"create_similar_app",inner:{tag:"button",style:"font-size: large; padding: 0.5em; margin: 1em 0; width: 100%;",inner:app_manager.user&&app_manager.user.isLoggedIn()&&app_manager.user.data().name===meta.creator?"Edit App Configuration":"Create Similar App",onclick:async()=>await showComponent($.convertComponentURL(meta.path).index,await $.solveDependency(["ccm.get",meta.source[0],meta.source[1]]))}}))}})};const showComponent=async(index,config)=>{this.routing&&this.routing.set(`component-${index}`);await menu.select("components",true);if(!this.component_manager)return $.setContent(content,"");await this.component_manager.start({root:content,data:{store:this.components,key:index},"ignore.create_similar_app":$.clone(config),onchange:async event=>{switch(event.event){case"edit":await components.set(event.dataset);break;case"del":await components.del(event.dataset.key);await menu.select("components");break}},onstart:async component_manager=>{const version_number=component_manager.element.querySelector("#version_number");if(!version_number)return;const options=[];let version=index.split("-");const identifier=version.shift();version=version.join(".");const versions=(await this.ccm.get(this.components,{identifier:identifier})).map(component=>component.version).sort($.compareVersions).reverse();versions.forEach(value=>options.push({tag:"option",inner:value,selected:value===version}));const component=await components.get(index);if(this.user&&this.user.isLoggedIn()&&component._&&component._.creator===this.user.data().key&&this.add_version)options.push({tag:"option",value:"add",inner:"Add Version"});options.length>1&&$.replace(version_number,$.html({tag:"select",id:"version_number",class:"text-muted",inner:options,onchange:async event=>{if(event.target.value==="add"){let url=prompt("Please enter the URL of the component version file:");if(!url||typeof url!=="string"||!$.regex("filename").test(url.split("/").pop()))return alert("Invalid component URL");url=$.convertComponentURL(url);if(url.name!==component.identifier)return alert("Invalid component name");if(versions.includes(url.version))return alert("Version already exists");component.path=url.url;component.version=url.version;component.key=url.index;delete component.created_at;delete component.updated_at;component.ignore.demos.forEach(demo=>demo.app[1]=component.path);await this.components.set(component);await components.set(component);await showComponent(component.key)}else showComponent(`${identifier}-${event.target.value.split(".").join("-")}`)}}))},"routing.2.app":this.routing.app+"_"+index.replace(/-/g,"_")})};const menu=await this.menu.start({root:this.element.querySelector("#menu"),onclick:event=>view[event.nr-1](),selected:this.routing&&this.routing.get()?null:undefined});if(this.lang){$.append(this.element.querySelector("#top"),this.lang.root);this.lang.start()}if(this.user)$.append(this.element.querySelector("#top"),this.user.root);this.lang&&this.lang.translate();this.routing&&await this.routing.define({home:()=>menu.select("home"),apps:()=>menu.select("apps"),components:()=>menu.select("components"),publish:()=>menu.select("publish"),app:showApp,component:(name,major,minor,patch)=>showComponent(`${name}-${major}-${minor}-${patch}`)})})}};let b="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[b])return window.ccm.files[b]=component;(b=window.ccm&&window.ccm.components[component.name])&&b.ccm&&(component.ccm=b.ccm);"string"===typeof component.ccm&&(component.ccm={url:component.ccm});let c=(component.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||["latest"])[0];if(window.ccm&&window.ccm[c])window.ccm[c].component(component);else{var a=document.createElement("script");document.head.appendChild(a);component.ccm.integrity&&a.setAttribute("integrity",component.ccm.integrity);component.ccm.crossorigin&&a.setAttribute("crossorigin",component.ccm.crossorigin);a.onload=function(){window.ccm[c].component(component);document.head.removeChild(a)};a.src=component.ccm.url}})();