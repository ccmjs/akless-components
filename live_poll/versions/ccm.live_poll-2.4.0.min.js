(()=>{const component={name:"live_poll",version:[2,4,0],ccm:"https://ccmjs.github.io/ccm/versions/ccm-25.2.1.js",config:{chart:["ccm.component","https://ccmjs.github.io/akless-components/highchart/versions/ccm.highchart-3.0.2.js"],converter:["ccm.load",{url:"https://ccmjs.github.io/akless-components/modules/json2json.mjs",type:"module",import:"poll_to_highchart"}],css:["ccm.load","https://ccmjs.github.io/akless-components/live_poll/resources/styles.css"],data:{store:["ccm.store"]},editable:true,helper:["ccm.load","https://ccmjs.github.io/akless-components/modules/versions/helper-4.2.0.mjs"],html:["ccm.load","https://ccmjs.github.io/akless-components/live_poll/resources/templates.html"],lock:true,placeholder:{start:"START",finish:"FINISH",reset:"RESET",locked:"ðŸ”’ <span>Locked</span>",unlocked:"ðŸ”“"},prompt:"Enter Password to Finish the Survey",user:["ccm.instance","https://ccmjs.github.io/akless-components/user/versions/ccm.user-9.4.0.js"]},Instance:function(){let $,dataset,user;this.init=(async()=>{$=Object.assign({},this.ccm.helper,this.helper);if($.isDatastore(this.data.store))this.data.store.onchange=this.start;if(this.show_results){this.onfinish=null;this.user=null}});this.ready=(async()=>{this.logger&&this.logger.log("ready",$.privatize(this,true))});this.start=(async()=>{const start=async()=>{dataset.members={};dataset.members[user]=0;dataset.active=true;dataset.result=dataset.question;this.logger&&this.logger.log("active",$.clone(dataset));await save()};const finish=async()=>{if(this.password&&prompt(this.prompt)!==this.password)return;dataset.active=false;this.logger&&this.logger.log("finish",$.clone(dataset));await save();await $.onFinish(this,$.clone(dataset))};const reset=async()=>{dataset.active="";dataset.members="";this.logger&&this.logger.log("reset",$.clone(dataset));await save()};const vote=async nr=>{if(!realtime)dataset=await $.dataset(this.data);if(!dataset.active)return;this.logger&&this.logger.log("vote",{answer:nr,before:dataset.members[user]});dataset.members[user]=nr;await save()};const save=async no_restart=>{if(!this.data||!$.isDatastore(this.data.store))return;await this.data.store.set(dataset);!no_restart&&await this.start()};const appendAnswer=(answer,i=dataset.answers.length)=>{if(i>=26)return;const getAnswerNr=input=>{let answer=input;do{answer=answer.parentElement}while(answer&&!answer.classList.contains("answer"));return parseInt(answer.id.split("-").pop())};this.element.querySelector("#answers").appendChild($.html(this.html.answer,{nr:(i+1).toString(),letter:String.fromCharCode(65+i),text:answer,editable:!locked,onclick:()=>vote(i+1),onblur:async event=>{event.target.textContent=event.target.textContent.trim();if(!event.target.textContent.trim())if(getAnswerNr(event.target)<dataset.answers.length){dataset.answers.splice(i,1);await save()}},oninput:async event=>{if(getAnswerNr(event.target)===dataset.answers.length)if(event.target.textContent.trim())if(dataset.answers.length<26){appendAnswer();dataset.answers.push("")}dataset.answers[i]=$.escapeHTML($.protect(event.target.textContent.trim()));await save(true);this.logger&&this.logger.log("input",$.clone(dataset))}}))};const realtime=this.data.store.source().url&&this.data.store.source().url.startsWith("ws");let locked=false;if(this.user){await this.user.login();user=this.user.data().user}dataset=await $.dataset(this.data);if(this.show_results){dataset.active=false;dataset.locked=true}if(dataset.active==="")delete dataset.active;if(dataset.members==="")delete dataset.members;if(dataset.active===undefined&&!this.editable)return start();this.logger&&this.logger.log("start",$.clone(dataset));if(dataset.locked&&dataset.locked!==user)locked=true;$.setContent(this.element,$.html(this.html.main,{question:dataset.question,lock:dataset.locked?this.placeholder.locked:this.placeholder.unlocked,button:this.placeholder[dataset.active?"finish":dataset.active===false?"reset":"start"],editable:!locked,onreload:this.start,oninput:async event=>{dataset.question=$.escapeHTML($.protect(event.target.textContent.trim()));await save(true);this.logger&&this.logger.log("input",$.clone(dataset))},onlock:async()=>{if(!realtime){const locked=dataset.locked;dataset=await $.dataset(this.data);if(dataset.locked!==locked)return await this.start()}if(!dataset.locked)dataset.locked=user;else if(user===dataset.locked||user===this.admin)dataset.locked="";else return;await save()},onclick:async()=>{if(!realtime){const active=dataset.active;dataset=await $.dataset(this.data);if(dataset.active!==active)return await this.start()}(dataset.active?finish:dataset.active===false?reset:start)()}}));realtime&&$.remove(this.element.querySelector("#reload"));!this.lock&&$.remove(this.element.querySelector("#lock"));if(locked){user!==this.admin&&$.remove(this.element.querySelector("#lock"));$.remove(this.element.querySelector("#button"))}if(!dataset.answers)dataset.answers=[];dataset.answers=dataset.answers.filter(answer=>answer&&answer.trim());dataset.active===undefined&&!locked&&dataset.answers.push("");dataset.answers.forEach(appendAnswer);dataset.members&&user&&dataset.members[user]&&this.element.querySelectorAll(".answer")[dataset.members[user]-1].classList.add("selected");if(dataset.active!==undefined){dataset.active&&this.element.querySelector("#main").classList.add("active");this.element.querySelectorAll("*[contenteditable]").forEach(div=>div.removeAttribute("contenteditable"))}if(this.chart&&dataset.members&&dataset.active===false){const votes=$.clone(dataset.members);for(const key in votes)if(!votes[key])delete votes[key];const config=this.converter(votes,$.clone(dataset.answers));config.root=this.element.querySelector("#results");this.chart.start(config)}const members_section=this.element.querySelector("#members");if(dataset.active&&!this.no_members_section&&members_section){const vote=dataset.members[user];if(vote===undefined){dataset.members[user]=0;await save();return}for(const member in dataset.members)if(dataset.members.hasOwnProperty(member)){members_section.appendChild($.html(this.html.member,{member:member}));if(dataset.members[member])members_section.lastChild.classList.add("done")}}else $.remove(members_section)});this.getValue=(()=>$.clone(dataset))}};let b="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[b])return window.ccm.files[b]=component;(b=window.ccm&&window.ccm.components[component.name])&&b.ccm&&(component.ccm=b.ccm);"string"===typeof component.ccm&&(component.ccm={url:component.ccm});let c=(component.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||["latest"])[0];if(window.ccm&&window.ccm[c])window.ccm[c].component(component);else{var a=document.createElement("script");document.head.appendChild(a);component.ccm.integrity&&a.setAttribute("integrity",component.ccm.integrity);component.ccm.crossorigin&&a.setAttribute("crossorigin",component.ccm.crossorigin);a.onload=function(){window.ccm[c].component(component);document.head.removeChild(a)};a.src=component.ccm.url}})();