(()=>{const component={name:"image_map_builder",ccm:"https://ccmjs.github.io/ccm/versions/ccm-27.3.1.min.js",config:{blank:"https://akless.github.io/akless/resources/images/blank/1x1.svg",css:["ccm.load",["https://ccmjs.github.io/akless-components/libs/bootstrap-5/css/bootstrap.min.css","https://ccmjs.github.io/akless-components/libs/bootstrap-5/css/bootstrap-dark.min.css","https://ccmjs.github.io/akless-components/config_builder/resources/styles.min.css","https://ccmjs.github.io/akless-components/image_map_builder/resources/styles.min.css"],"https://ccmjs.github.io/akless-components/libs/bootstrap-5/css/bootstrap-icons.min.css",{url:"https://ccmjs.github.io/akless-components/libs/bootstrap-5/css/bootstrap-fonts.min.css",context:"head"}],dark:false,data:{},helper:["ccm.load","https://ccmjs.github.io/akless-components/modules/versions/helper-8.1.0.min.mjs"],html:["ccm.load","https://ccmjs.github.io/akless-components/image_map_builder/resources/templates.mjs"],ignore:{defaults:{dark:false}},image_map:["ccm.component","https://ccmjs.github.io/akless-components/image_map/versions/ccm.image_map-4.0.0.min.js"],libs:["ccm.load","https://ccmjs.github.io/akless-components/libs/bootstrap-5/js/bootstrap.bundle.min.js","https://ccmjs.github.io/akless-components/libs/moveable/moveable.min.js"],preview:true,quill:{comp:["ccm.component","https://ccmjs.github.io/akless-components/quill/versions/ccm.quill-2.0.0.min.js",{html:true}],map:{"options.modules.toolbar":[[{header:[1,2,3,4,5,6,false]}],["bold","italic","underline","strike"],[{script:"super"},{script:"sub"}],[{list:"ordered"},{list:"bullet"}],["link","image","video"],["clean"]]},area:{"options.modules.toolbar":[[{header:1}],["bold","italic","underline","strike"],[{script:"super"},{script:"sub"}],["link"],["clean"]]}},shadow:"none",submit:true,text:["ccm.load","https://ccmjs.github.io/akless-components/image_map_builder/resources/resources.mjs#en"],tool:["ccm.component","https://ccmjs.github.io/akless-components/image_map/versions/ccm.image_map-4.0.0.min.js"]},Instance:function(){let $;let config={};let image_map;let quill_map;let quill_area;this.init=(async()=>{$=Object.assign({},this.ccm.helper,this.helper);$.use(this.ccm);if(this.lang)this.lang.dark=this.dark;if(this.user)this.user.dark=this.dark});this.ready=(async()=>{this.logger&&this.logger.log("ready",$.privatize(this,true));this.element.classList.add(this.component.name);this.dark==="auto"&&this.element.classList.add("dark_auto");this.dark===true&&this.element.classList.add("dark_mode")});this.start=(async()=>{this.user&&await this.user.login();config=await $.integrate(await $.dataset(this.data),await $.integrate(this.ignore.defaults,this.tool.config));if(!config.ignore)config.ignore={};if(!config.ignore.areas)config.ignore.areas=[];if(this.onstart)config=await this.onstart({instance:this,config:config});this.logger&&this.logger.log("start",$.clone(config));this.html.render(this.html.main(config,this,events),this.element);quill_map=await this.quill.comp.start({data:{value:config.info},root:this.element.querySelector("#"+this.component.name+"-map-info"),src:this.quill.map});new bootstrap.Modal(this.element.querySelector("#"+this.component.name+"-modal"));await renderAreaPlacement();const header=this.element.querySelector("#"+this.component.name+"-header");if(header){header&&this.lang&&!this.lang.getContext()&&$.append(header,this.lang.root);header&&this.user&&$.append(header,this.user.root)}});this.getValue=(()=>{const value=$.assign($.clone(config),$.formData(this.element.querySelector("#"+this.component.name+"-form")));value.info=quill_map.getValue().value;value.ignore.areas.forEach(area=>{delete area.quill;if(!area.height)delete area.height});return value});const events={onAddArea:async()=>openAreaModal(),onChange:()=>renderAreaPlacement(),onDblClickArea:async area_nr=>openAreaModal(area_nr),onDeleteArea:async()=>{config.ignore.areas.splice(parseInt(this.element.querySelector("#"+this.component.name+'-modal [name="nr"]').value)-1,1);await renderAreaPlacement()},onDeleteAreas:async()=>{if(!confirm(this.lang?this.lang.translate("confirm"):this.text.confirm))return;config.ignore.areas=[];await renderAreaPlacement()},onPreview:()=>{const preview_body=this.element.querySelector("#"+this.component.name+"-preview .modal-body");$.setContent(preview_body,"");this.logger&&this.logger.log("preview",$.clone(config));this.tool.start(Object.assign(this.getValue(),{root:preview_body}))},onSubmitMap:event=>{event.preventDefault();const config=this.getValue();this.logger&&this.logger.log("finish",$.clone(config));$.onFinish(this,config)},onSubmitArea:async event=>{event.preventDefault();const $modal=this.element.querySelector("#"+this.component.name+"-modal");const{area:area,nr:nr}=$.formData($modal);const areas=config.ignore.areas;if(!nr)areas.push($.assign(area,{width:64,height:64}));const area_data=areas[parseInt(nr||areas.length)-1];area_data.image=area.image;area_data.info=(area_data.quill||quill_area).getValue().value;area_data.app=area.app;bootstrap.Modal.getInstance($modal).hide();if(!nr)await renderAreaPlacement()}};const renderAreaPlacement=async()=>{const copy=this.getValue();const preload=["ccm.load"];copy.ignore.areas.forEach(area=>{delete area.app;delete area.info;area.image&&preload.push(area.image)});delete copy.info;delete copy.user;delete copy.lang;delete copy.routing;copy.libs=false;copy.dark=this.dark;copy.root=this.element.querySelector("#"+this.component.name+"-placement");await $.solveDependency(preload);if(image_map){image_map.image=copy.image;image_map.ignore.areas=copy.ignore.areas;await image_map.start()}else image_map=await this.image_map.start(copy);image_map.element.querySelectorAll(".area").forEach(($area,i)=>{$area.style.backgroundColor="rgba( 128, 128, 128, 0.2 )";$area.addEventListener("dblclick",()=>events.onDblClickArea(i+1));const area=config.ignore.areas[i];new Moveable(image_map.element.querySelector("#map"),{target:$area,draggable:true,resizable:true,origin:false,keepRatio:false,renderDirections:["e","s","se"]}).on("drag",({target:target,left:left,top:top})=>{target.style.left=`${left}px`;target.style.top=`${top}px`;area.x=left;area.y=top}).on("resize",({target:target,width:width,height:height,delta:delta})=>{delta[0]&&(target.style.width=`${area.width=width}px`);delta[1]&&(target.style.height=`${area.height=height}px`)})})};const openAreaModal=async area_nr=>{const $modal=this.element.querySelector("#"+this.component.name+"-modal");const areas=config.ignore.areas;const area_data=areas[area_nr-1]||{image:this.blank,app:"",info:""};$.fillForm($modal,{area:area_data,nr:area_nr||""});$modal.querySelector("#"+this.component.name+"-delete").style.display=area_nr?"block":"none";if(area_data.quill)area_data.quill.setHTML(area_data.info);else area_data.quill=quill_area=await this.quill.comp.start({data:{value:area_data.info},src:this.quill.area});$.setContent($modal.querySelector("#"+this.component.name+"-area-info"),area_data.quill.root);bootstrap.Modal.getInstance($modal).show()}}};let b="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[b])return window.ccm.files[b]=component;(b=window.ccm&&window.ccm.components[component.name])&&b.ccm&&(component.ccm=b.ccm);"string"===typeof component.ccm&&(component.ccm={url:component.ccm});let c=(component.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||[""])[0];if(window.ccm&&window.ccm[c])window.ccm[c].component(component);else{var a=document.createElement("script");document.head.appendChild(a);component.ccm.integrity&&a.setAttribute("integrity",component.ccm.integrity);component.ccm.crossorigin&&a.setAttribute("crossorigin",component.ccm.crossorigin);a.onload=function(){(c="latest"?window.ccm:window.ccm[c]).component(component);document.head.removeChild(a)};a.src=component.ccm.url}})();