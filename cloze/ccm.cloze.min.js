(()=>{const component={name:"cloze",ccm:"https://ccmjs.github.io/ccm/versions/ccm-25.5.2.js",config:{captions:{start:"Start",cancel:"Cancel",submit:"Submit",retry:"Retry",finish:"Finish"},css:["ccm.load","https://ccmjs.github.io/akless-components/cloze/resources/default.css"],feedback:true,helper:["ccm.load","https://ccmjs.github.io/akless-components/modules/versions/helper-5.1.0.mjs"],html:["ccm.load","https://ccmjs.github.io/akless-components/cloze/resources/templates.html"],keywords:true,mark:"*",retry:true,text:"Hello, *(W)o(rl)d*! *Welcome*. This is an *Ex(amp)le*."},Instance:function(){const self=this;let $;let keywords=[];let results=null;this.init=(async()=>{if(self.inner&&self.inner.innerHTML.trim())self.text=self.inner.innerHTML;if(self.show_results){self.feedback=false;self.start_button=false;self.time=0;self.cancel_button=false;self.onfinish=null}});this.ready=(async()=>{$=Object.assign({},self.ccm.helper,self.helper);const regex_keyword=new RegExp("\\"+self.mark+".+?\\"+self.mark,"g");const regex_given=/\(.+?\)/g;const regex_reference=/^#(\d+)$/;(self.text.match(regex_keyword)||[]).forEach(keyword=>{keyword=keyword.substr(1,keyword.length-2);keyword=$.unescapeHTML(keyword);if(regex_reference.test(keyword))return keywords.push(keywords[keyword.substr(1)-1]);const entry=[];const split=keyword.split("/");split.forEach((value,i)=>{if(value.endsWith("<")&&i+1<split.length){split[i+1]=split[i]+"/"+split[i+1];return}entry.push(determineKeywordData(value.trim()))});keywords.push(entry);function determineKeywordData(keyword){const keyw__d=keyword.replace("*","#").replace(regex_given,given=>{const length=given.length-2;given="";for(let i=0;i<length;i++)given+="*";return given});let givens=0;for(let i=0;i<keyw__d.length;i++)if(keyw__d.charAt(i)==="*")givens+=Math.pow(2,i);return{word:keyword.replace(regex_given,given=>given.substr(1,given.length-2)),givens:givens}}});self.text=self.text.replace(regex_keyword,'<span class="gap"></span>');self.logger&&self.logger.log("ready",$.privatize(self,true))});this.start=(async()=>{results={sections:[]};self.logger&&self.logger.log("render");if(self.start_button)$.setContent(self.element,$.html(self.html.start,{caption:self.captions.start,onclick:start}));else await start();async function start(){const dataset=await $.dataset(self.data);self.logger&&self.logger.log("start",$.clone(dataset));const main_elem=$.html(self.html.main);const text_elem=main_elem.querySelector("#text");const cancel_elem=main_elem.querySelector("#cancel");const submit_elem=main_elem.querySelector("#submit");const finish_elem=main_elem.querySelector("#finish");const timer_elem=main_elem.querySelector("#timer");!self.cancel_button&&$.remove(cancel_elem);!self.feedback&&$.remove(submit_elem);renderKeywords();renderText();renderInitialButtons();renderTimer();$.setContent(self.element,main_elem);self.show_results&&evaluate();self.onstart&&self.onstart(self);function renderKeywords(){const keywords_elem=main_elem.querySelector("#keywords");if(!self.keywords)return $.remove(keywords_elem);const entries=[];(self.keywords===true?keywords:self.keywords).forEach(keyword=>{entries.push($.html(self.html.keyword,{keyword:$.escapeHTML(self.keywords===true?keyword[0].word:keyword),onclick:function(){this.classList.toggle("marked")}}))});if(self.keywords===true)entries.sort((a,b)=>a.innerHTML.localeCompare(b.innerHTML));entries.forEach(entry=>keywords_elem.appendChild(entry))}function renderText(){text_elem.innerHTML=self.text;let size=0;keywords.forEach(keyword=>keyword.forEach(keyword=>{if(keyword.word.length>size)size=keyword.word.length}));[...main_elem.querySelectorAll(".gap")].forEach((gap_elem,i)=>{const input=$.html(self.html.input,{oninput:onInput,onchange:onChange});if(dataset&&dataset.sections&&dataset.sections[i]&&dataset.sections[i].input)input.value=dataset.sections[i].input;input.onkeypress=input.onkeydown=function(){this.size=this.value.length>10?this.value.length:10};input.onpaste=function(){window.setTimeout(()=>this.size=this.value.length>10?this.value.length:10,0)};if(!self.blank){const keyword=keywords[i][0].word;input.placeholder="";for(let j=0;j<keyword.length;j++)input.placeholder+=Math.pow(2,j)&keywords[i][0].givens?keyword.charAt(j):"_"}gap_elem.appendChild($.html(input));function onInput(){const event_data={gap:1+i,input:this.value};self.logger&&self.logger.log("input",$.clone(event_data));self.oninput&&self.oninput(self,$.clone(event_data))}function onChange(){const event_data={gap:1+i,input:this.value};self.logger&&self.logger.log("change",$.clone(event_data));self.onchange&&self.onchange(self,$.clone(event_data))}})}function renderInitialButtons(){self.cancel_button&&renderButton(cancel_elem,self.captions.cancel,()=>self.oncancel?self.oncancel(self):self.start(callback));self.feedback&&renderButton(submit_elem,self.captions.submit,evaluate);self.onfinish&&renderButton(finish_elem,self.captions.finish,onFinish)}function renderTimer(){if(!self.time||!self.onfinish&&!self.feedback)return $.remove(timer_elem);let timer_value=self.time;timer();function timer(){if(!finish_elem)return;$.setContent(timer_elem,$.html(self.html.timer,timer_value));if(timer_value--)window.setTimeout(timer,1e3);else self.feedback?evaluate():onFinish()}}function evaluate(){results.sections=[];results.correct=0;[...main_elem.querySelectorAll(".gap input")].forEach((gap,i)=>{const event_data={gap:1+i,input:gap.value,solution:[],correct:false,nearly:false};event_data.solution=[];keywords[i].forEach(keyword=>{event_data.solution.push(keyword.word);if(keyword.used)return;gap.value=gap.value.trim();if(gap.value===keyword.word){event_data.correct=true;results.correct++}if(gap.value.toLowerCase()===keyword.word.toLowerCase()){event_data.nearly=true;keyword.used=true}self.onvalidation&&!self.onvalidation(self,event_data)});gap.disabled=true;if(self.feedback){if(!event_data.nearly&&self.solutions)gap.value="";if(self.solutions){let placeholder="";for(let j=0;j<keywords[i].length;j++)if(!keywords[i][j].used){placeholder=keywords[i][j].word;break}gap.setAttribute("placeholder",placeholder);placeholder.length<=0?gap.size=gap.value.length||gap.size:gap.size=placeholder.length||gap.size;gap.size*=1.2}gap.parentNode.classList.add(event_data.correct?"correct":event_data.nearly?"nearly":"wrong")}results.sections.push(event_data)});keywords.forEach(keyword=>keyword.forEach(keyword=>delete keyword.used));if(results.sections.length===0)return;self.logger&&self.logger.log("feedback",$.clone(results));self.onfeedback&&self.onfeedback(self,$.clone(results));updateButtons(true);self.progress_bar&&self.feedback&&renderProgressBar(results.correct);function renderProgressBar(correct){$.setContent(main_elem.querySelector("#conclusion"),$.html(self.html.feedback,{points:correct+"/"+keywords.length}));const goal=correct*main_elem.querySelector("#feedback").offsetWidth/keywords.length;let width=1;let id=setInterval(frame,10);function frame(){if(width>=goal||!main_elem.querySelector("#progress-bar"))clearInterval(id);else{width++;main_elem.querySelector("#progress-bar").style.width=width+"px"}}}}function retry(){$.setContent(main_elem.querySelector("#conclusion"),"");[...self.element.querySelectorAll(".gap")].forEach(gap=>{gap.classList.remove("correct","nearly","wrong");const input=gap.querySelector("input");input.disabled=false});self.logger&&self.logger.log("retry");updateButtons(false)}function updateButtons(evaluated){if(!self.feedback)return;if(!evaluated)renderButton(submit_elem,self.captions.submit,evaluate);else if(self.retry&&!self.solutions)renderButton(submit_elem,self.captions.retry,retry);else submit_elem.querySelector("button").disabled=true}function renderButton(element,caption,click){$.setContent(element,$.html(self.html.button,{caption:caption,onclick:click}))}async function onFinish(){if(!self.onfinish)return;results.sections.length===0&&evaluate();$.remove(finish_elem);$.remove(timer_elem);results.total=results.sections.length;self.logger&&self.logger.log("finish",$.clone(results));$.onFinish(self)}}});this.getValue=(()=>results)}};let b="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[b])return window.ccm.files[b]=component;(b=window.ccm&&window.ccm.components[component.name])&&b.ccm&&(component.ccm=b.ccm);"string"===typeof component.ccm&&(component.ccm={url:component.ccm});let c=(component.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||["latest"])[0];if(window.ccm&&window.ccm[c])window.ccm[c].component(component);else{var a=document.createElement("script");document.head.appendChild(a);component.ccm.integrity&&a.setAttribute("integrity",component.ccm.integrity);component.ccm.crossorigin&&a.setAttribute("crossorigin",component.ccm.crossorigin);a.onload=function(){window.ccm[c].component(component);document.head.removeChild(a)};a.src=component.ccm.url}})();