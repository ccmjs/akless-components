(()=>{const component={name:"cloze",version:[8,0,1],ccm:"https://ccmjs.github.io/ccm/versions/ccm-26.1.1.js",config:{captions:{start:"Start",reset:"Reset",feedback:"Feedback",retry:"Retry",finish:"Finish"},css:["ccm.load","https://ccmjs.github.io/akless-components/cloze/resources/default.css"],helper:["ccm.load","https://ccmjs.github.io/akless-components/modules/versions/helper-7.0.0.mjs"],html:["ccm.load","https://ccmjs.github.io/akless-components/cloze/resources/templates.mjs"],mark:"*",text:"Hello, *(W)o(rl)d*! *Welcome*. This is an *Ex(amp)le*."},Instance:function(){const self=this;let $,id;const keywords_data=[];let results=null;this.init=(async()=>{$=Object.assign({},this.ccm.helper,this.helper);$.use(this.ccm);if(this.inner&&this.inner.innerHTML.trim())this.text=this.inner.innerHTML;if($.isObject(this.text))this.text=this.text.inner;if(this.show_results){this.feedback=false;this.start_button=false;this.time=0;this.onreset=false;this.onfinish=null}});this.ready=(async()=>{const regex_keyword=new RegExp("\\"+this.mark+".+?\\"+this.mark,"g");const regex_keyword_=new RegExp("(\\"+this.mark+".+?\\"+this.mark+")(</.*?>)?( )","g");const regex_given=/\(.+?\)/g;const regex_reference=/^#(\d+)$/;(this.text.match(regex_keyword)||[]).forEach(keyword=>{keyword=keyword.substr(1,keyword.length-2);keyword=$.unescapeHTML(keyword);if(regex_reference.test(keyword))return keywords_data.push(keywords_data[keyword.substr(1)-1]);const entry=[];const split=keyword.split("/");split.forEach((value,i)=>{if(value.endsWith("<")&&i+1<split.length){split[i+1]=split[i]+"/"+split[i+1];return}entry.push(determineKeywordData(value.trim()))});keywords_data.push(entry);function determineKeywordData(keyword){const keyw__d=keyword.replace("*","#").replace(regex_given,given=>{const length=given.length-2;given="";for(let i=0;i<length;i++)given+="*";return given});let givens=0;for(let i=0;i<keyw__d.length;i++)if(keyw__d.charAt(i)==="*")givens+=Math.pow(2,i);keyword=keyword.replace(regex_given,given=>given.substr(1,given.length-2));let placeholder="";if(!self.blank)for(let j=0;j<keyword.length;j++)placeholder+=Math.pow(2,j)&givens?keyword.charAt(j):"_";return{word:keyword,placeholder:placeholder}}});this.text=this.text.replace(regex_keyword_,"$1"+"$2"+"&nbsp;");this.text=this.text.replace(regex_keyword,'<span class="gap"></span>');this.logger&&this.logger.log("ready",$.privatize(this,true))});this.start=(async()=>{results={sections:[]};this.logger&&this.logger.log("render");if(this.start_button)this.html.render(this.html.startButton(this.captions.start,start),this.element);else await start();async function start(){const dataset=await $.dataset(self.data);self.logger&&self.logger.log("start",$.clone(dataset));const keywords=self.keywords===true?keywords_data.map(keyword=>keyword[0].word):self.keywords;self.keywords===true&&keywords.sort((a,b)=>a.localeCompare(b));self.html.render(self.html.main(self,keywords),self.element);self.element.querySelector("#text").innerHTML=self.text;let max_length=0;keywords_data.forEach(keyword=>keyword.forEach(keyword=>{if(keyword.word.length>max_length)max_length=keyword.word.length}));self.element.querySelectorAll(".gap").forEach((gap_elem,i)=>{const value=$.deepValue(dataset,"sections."+i+".input");const size=self.blank?this.size||max_length:keywords_data[i][0].word.length;const maxlength=self.blank?max_length:size;const onInput=()=>{const event_data={gap:1+i,input:this.value};self.logger&&self.logger.log("input",$.clone(event_data));self.oninput&&self.oninput(self,$.clone(event_data))};const onChange=()=>{const event_data={gap:1+i,input:this.value};self.logger&&self.logger.log("change",$.clone(event_data));self.onchange&&self.onchange(self,$.clone(event_data))};self.html.render(self.html.inputField(value,keywords_data[i][0].placeholder,size*1.11,maxlength,onInput,onChange),gap_elem)});self.html.render(self.html.buttons(self,self.onreset!==false&&onReset,self.feedback&&evaluate,null,self.onfinish&&onFinish),self.element.querySelector("#buttons"));self.time&&renderTimer();self.show_results&&evaluate();self.onstart&&self.onstart(self);function onReset(){if(self.onreset)return self.onreset(self);self.html.render(self.html.conclusion(),self.element.querySelector("#conclusion"));self.start()}function evaluate(){results.sections=[];results.correct=0;self.element.querySelectorAll(".gap input").forEach((gap,i)=>{const event_data={gap:1+i,input:gap.value,solution:[],correct:false,nearly:false};event_data.solution=[];keywords_data[i].forEach(keyword=>{event_data.solution.push(keyword.word);if(keyword.used)return;gap.value=gap.value.trim();if(gap.value===keyword.word){event_data.correct=true;results.correct++}if(gap.value.toLowerCase()===keyword.word.toLowerCase()){event_data.nearly=true;keyword.used=true}self.onvalidation&&!self.onvalidation(self,event_data)});gap.disabled=true;if(self.feedback){if(!event_data.nearly&&self.solutions)gap.value="";if(self.solutions){let placeholder="";for(let j=0;j<keywords_data[i].length;j++)if(!keywords_data[i][j].used){placeholder=keywords_data[i][j].word;break}gap.setAttribute("placeholder",placeholder)}gap.parentNode.classList.add(event_data.correct?"correct":event_data.nearly?"nearly":"wrong")}results.sections.push(event_data)});keywords_data.forEach(keyword=>keyword.forEach(keyword=>delete keyword.used));if(results.sections.length===0)return;self.logger&&self.logger.log("feedback",$.clone(results));self.onfeedback&&self.onfeedback(self,$.clone(results));self.html.render(self.html.buttons(self,self.onreset!==false&&onReset,null,self.retry&&retry,self.onfinish&&onFinish),self.element.querySelector("#buttons"));self.progress_bar&&self.feedback&&self.html.render(self.html.conclusion(results.correct,keywords_data.length),self.element.querySelector("#conclusion"))}function retry(){self.logger&&self.logger.log("retry");self.element.querySelectorAll(".gap").forEach((gap,i)=>{gap.classList.remove("correct","nearly","wrong");const input=gap.querySelector("input");input.disabled=false;input.placeholder=keywords_data[i][0].placeholder});self.html.render(self.html.buttons(self,self.onreset!==false&&onReset,evaluate,null,self.onfinish&&onFinish),self.element.querySelector("#buttons"));self.html.render(self.html.conclusion(),self.element.querySelector("#conclusion"))}async function onFinish(){results.sections.length===0&&evaluate();results.total=results.sections.length;self.html.render(self.html.buttons(self,onReset),self.element.querySelector("#buttons"));self.html.render(self.html.conclusion(),self.element.querySelector("#conclusion"));self.logger&&self.logger.log("finish",$.clone(results));$.onFinish(self)}function renderTimer(){let countdown=self.time;let my_id=Date.now();id=my_id;timer();function timer(){if(results.total||id!==my_id)return;const timer_elem=self.element.querySelector("#timer");$.setContent(timer_elem,countdown);if(countdown--)window.setTimeout(timer,1e3);else self.feedback?evaluate():onFinish()}}}});this.getValue=(()=>results)}};let b="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[b])return window.ccm.files[b]=component;(b=window.ccm&&window.ccm.components[component.name])&&b.ccm&&(component.ccm=b.ccm);"string"===typeof component.ccm&&(component.ccm={url:component.ccm});let c=(component.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||[""])[0];if(window.ccm&&window.ccm[c])window.ccm[c].component(component);else{var a=document.createElement("script");document.head.appendChild(a);component.ccm.integrity&&a.setAttribute("integrity",component.ccm.integrity);component.ccm.crossorigin&&a.setAttribute("crossorigin",component.ccm.crossorigin);a.onload=function(){(c="latest"?window.ccm:window.ccm[c]).component(component);document.head.removeChild(a)};a.src=component.ccm.url}})();